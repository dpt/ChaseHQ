<!DOCTYPE html>
<html>
<head>
<title>Chase H.Q.: Routine at ED4D</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Chase H.Q.</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="ECF3.html">ECF3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60749">Map</a></td>
<td class="next">
Next: <a href="ED6D.html">ED6D</a>
</td>
</tr>
</table>
<div class="description">ED4D: Keyscan</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="ED6D.html">ED6D</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">want</td>
<td class="register-desc">some examples here</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60749"></span>
<div class="comments">
<div class="paragraph">
O:D Key half-row number in bits 0..2, key in bits 3+  [or is it inverted?] or $FF if no keys pressed O:F Z clear if keys are pressed 47 = 00101111 = kkkkkrrr (k = key is 5, r = row is 7)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">keyscan_all</td>
<td class="address-2"><span id="60749"></span>ED4D</td>
<td class="instruction">LD DE,$FF2F</td>
<td class="comment-1" rowspan="1"><span class="register">D</span> = flag/counter? (255 to start), <span class="register">E</span> = initial key and row counters (47 to start)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60752"></span>ED50</td>
<td class="instruction">LD BC,$FEFE</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to $FE (initial keyboard half-row selector) and <span class="register">C</span> to $FE (keyboard port number)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60755"></span>
<div class="comments">
<div class="paragraph">
Start loop.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ka_loop</td>
<td class="address-2"><span id="60755"></span>ED53</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-1" rowspan="1">Read port $&lt;BC&gt;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60757"></span>ED55</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">Complement the value returned to change it from active-low to active-high</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60758"></span>ED56</td>
<td class="instruction">AND $1F</td>
<td class="comment-1" rowspan="1">Discard any non-key flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60760"></span>ED58</td>
<td class="instruction">JR Z,<a href="ED4D.html#60774">keyscan_all_1</a></td>
<td class="comment-1" rowspan="1">Jump to next iteration if no keys were pressed</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60762"></span>
<div class="comments">
<div class="paragraph">
Keys were pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60762"></span>ED5A</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">?If <span class="register">D'</span>s 255 here we're okay. anything else causes an exit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60763"></span>ED5B</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if <span class="register">D</span> is non-zero</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60764"></span>ED5C</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Copy key flags to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60765"></span>ED5D</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1">Copy key and row counters to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label">keyscan_all_0</td>
<td class="address-2"><span id="60766"></span>ED5E</td>
<td class="instruction">SUB $08</td>
<td class="comment-1" rowspan="1">Decrement key counter bitfield in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60768"></span>ED60</td>
<td class="instruction">SRL H</td>
<td class="comment-1" rowspan="1">Shift a key bit out of <span class="register">H</span> into the carry flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60770"></span>ED62</td>
<td class="instruction">JR NC,<a href="ED4D.html#60766">keyscan_all_0</a></td>
<td class="comment-1" rowspan="1">Loop until we hit a set bit (at least one must be set since the zero case is handled earlier)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60772"></span>ED64</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if additional bits are set</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60773"></span>ED65</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Set return value in <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label">keyscan_all_1</td>
<td class="address-2"><span id="60774"></span>ED66</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1">Decrement <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60775"></span>ED67</td>
<td class="instruction">RLC B</td>
<td class="comment-1" rowspan="1">Rotate the half-row selector ($FE -&gt; $FD -&gt; $FB -&gt; .. -&gt; $7F)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60777"></span>ED69</td>
<td class="instruction">JR C,<a href="ED4D.html#60755">ka_loop</a></td>
<td class="comment-1" rowspan="1">...loop until the zero bit shifts out (eight iterations)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60779"></span>ED6B</td>
<td class="instruction">CP A</td>
<td class="comment-1" rowspan="2">Set Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60780"></span>ED6C</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="ECF3.html">ECF3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60749">Map</a></td>
<td class="next">
Next: <a href="ED6D.html">ED6D</a>
</td>
</tr>
</table>
<footer>
<div class="release">The incomplete Chase H.Q. disassembly 20231102</div>
<div class="copyright">&copy; 1988 Taito Corporation &copy; 1989 Ocean Software Ltd. (Chase H.Q.) Â© 2023 David Thomas (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.9.</div>
</footer>
</body>
</html>