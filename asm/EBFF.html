<!DOCTYPE html>
<html>
<head>
<title>Chase H.Q.: Routine at EBFF</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Chase H.Q.</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="EBF7.html">EBF7</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60415">Map</a></td>
<td class="next">
Next: <a href="EC2C.html">EC2C</a>
</td>
</tr>
</table>
<div class="description">EBFF: Renders a string.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="EBF7.html">menu_draw_strings</a> and <a href="ED6D.html">ED6D</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of a message structure (byte: attribute byte, word: destination screen address, bytes: top bit set terminated ASCII string)</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of next unconsumed byte</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">menu_draw_string</td>
<td class="address-2"><span id="60415"></span>EBFF</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Load attribute byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60416"></span>EC00</td>
<td class="instruction">RL C</td>
<td class="comment-1" rowspan="3">Bank the top bit of the attribute byte as the C flag (this is the single height flag)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60418"></span>EC02</td>
<td class="instruction">EX AF,AF'</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60419"></span>EC03</td>
<td class="instruction">SRL C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60421"></span>EC05</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60422"></span>EC06</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="4">Load screen address into <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60423"></span>EC07</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60424"></span>EC08</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60425"></span>EC09</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60426"></span>EC0A</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Stack screen address</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60427"></span>
<div class="comments">
<div class="paragraph">
Calculate the attribute address from the screen address
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60427"></span>EC0B</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="7"><span class="register">H</span> = $58 + ((D &gt;&gt; 3) &amp; 3)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60428"></span>EC0C</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60429"></span>EC0D</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60430"></span>EC0E</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60431"></span>EC0F</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60433"></span>EC11</td>
<td class="instruction">ADD A,$58</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60435"></span>EC13</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60436"></span>EC14</td>
<td class="instruction">LD L,E</td>
<td class="comment-1" rowspan="1"><span class="register">L</span> = E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60437"></span>EC15</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60438"></span>
<div class="comments">
<div class="paragraph">
<span class="register">HL'</span> is screen address, <span class="register">DE'</span> is attribute address
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60438"></span>EC16</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-1" rowspan="1">Get screen address and preserve old <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60439"></span>EC17</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="2">Preserve regs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60440"></span>EC18</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="asm-label">menu_draw_string_loop</td>
<td class="address-2"><span id="60441"></span>EC19</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Mask off the terminator bit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60442"></span>EC1A</td>
<td class="instruction">AND $7F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60444"></span>EC1C</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> = Character to draw</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60445"></span>EC1D</td>
<td class="instruction">CALL <a href="EC2C.html">menu_draw_char</a></td>
<td class="comment-1" rowspan="1">Draw the character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60448"></span>EC20</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60449"></span>EC21</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">End of string?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60451"></span>EC23</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to next char irrespective</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60452"></span>EC24</td>
<td class="instruction">JR Z,<a href="EBFF.html#60441">menu_draw_string_loop</a></td>
<td class="comment-1" rowspan="1">Loop if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60454"></span>EC26</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60455"></span>EC27</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="3">Restore regs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60456"></span>EC28</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60457"></span>EC29</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60458"></span>EC2A</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="60459"></span>EC2B</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="EBF7.html">EBF7</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60415">Map</a></td>
<td class="next">
Next: <a href="EC2C.html">EC2C</a>
</td>
</tr>
</table>
<footer>
<div class="release">The incomplete Chase H.Q. disassembly 20230518</div>
<div class="copyright">&copy; 1988 Taito Corporation &copy; 1989 Ocean Software Ltd. (Chase H.Q.) Â© 2023 David Thomas (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.9.</div>
</footer>
</body>
</html>