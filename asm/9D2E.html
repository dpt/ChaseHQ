<!DOCTYPE html>
<html>
<head>
<title>Chase H.Q.: Routine at 9D2E</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Chase H.Q.</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9D17.html">9D17</a>
</td>
<td class="up">Up: <a href="../maps/all.html#40238">Map</a></td>
<td class="next">
Next: <a href="9D51.html">9D51</a>
</td>
</tr>
</table>
<div class="description">9D2E: Calculate overtake bonus</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Bonus is 200 for each overtaken car, reset on crashes.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">Used</td>
<td class="register-desc">by the routine at <a href="8401.html">main_loop</a>.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="40238"></span>
<div class="comments">
<div class="paragraph">
I:A Iterations (number of sequential overtakes to consider)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">calc_overtake_bonus</td>
<td class="address-2"><span id="40238"></span>9D2E</td>
<td class="instruction">LD A,($A22B)</td>
<td class="comment-1" rowspan="3">If allow_overtake_bonus is zero then return</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40241"></span>9D31</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40242"></span>9D32</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40243"></span>9D33</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">B = A -- iterations / no. of overtakes</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40244"></span>9D34</td>
<td class="instruction">LD HL,$A13C</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at overtake_bonus</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="40247"></span>
<div class="comments">
<div class="paragraph">
Increment bonus by 2 up to a max of 128.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cob_overtake_loop</td>
<td class="address-2"><span id="40247"></span>9D37</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">A = *HL + 2</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40248"></span>9D38</td>
<td class="instruction">ADD A,$02</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40250"></span>9D3A</td>
<td class="instruction">DAA</td>
<td class="comment-1" rowspan="1">BCD correction</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40251"></span>9D3B</td>
<td class="instruction">CP $80</td>
<td class="comment-1" rowspan="3">If A &gt;= 128 then A = 128  [80 in BCD]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40253"></span>9D3D</td>
<td class="instruction">JR C,<a href="9D2E.html#40257">calc_overtake_bonus_0</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40255"></span>9D3F</td>
<td class="instruction">LD A,$80</td>
</tr>
<tr>
<td class="asm-label">calc_overtake_bonus_0</td>
<td class="address-2"><span id="40257"></span>9D41</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">*HL = A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40258"></span>9D42</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="40259"></span>
<div class="comments">
<div class="paragraph">
Set bonus to N * 100.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40259"></span>9D43</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Set middle digits</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40260"></span>9D44</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear low digit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40261"></span>9D45</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Clear top two digits</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40262"></span>9D46</td>
<td class="instruction">CALL <a href="9CD6.html">bonus</a></td>
<td class="comment-1" rowspan="1">Call bonus</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40265"></span>9D49</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40266"></span>9D4A</td>
<td class="instruction">DJNZ <a href="9D2E.html#40247">cob_overtake_loop</a></td>
<td class="comment-1" rowspan="1">Loop while <span class="register">B</span> &gt; 0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40268"></span>9D4C</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear allow_overtake_bonus</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40269"></span>9D4D</td>
<td class="instruction">LD ($A22B),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="40272"></span>9D50</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9D17.html">9D17</a>
</td>
<td class="up">Up: <a href="../maps/all.html#40238">Map</a></td>
<td class="next">
Next: <a href="9D51.html">9D51</a>
</td>
</tr>
</table>
<footer>
<div class="release">The incomplete Chase H.Q. disassembly 20231102</div>
<div class="copyright">&copy; 1988 Taito Corporation &copy; 1989 Ocean Software Ltd. (Chase H.Q.) Â© 2023 David Thomas (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.9.</div>
</footer>
</body>
</html>