<!DOCTYPE html>
<html>
<head>
<title>Chase H.Q.: Routine at 8014</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Chase H.Q.</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8008.html">8008</a>
</td>
<td class="up">Up: <a href="../maps/all.html#32788">Map</a></td>
<td class="next">
Next: <a href="80B9.html">80B9</a>
</td>
</tr>
</table>
<div class="description">8014: Load a stage</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="8401.html">main_loop</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">load_stage</td>
<td class="address-2"><span id="32788"></span>8014</td>
<td class="instruction">LD A,($8007)</td>
<td class="comment-1" rowspan="1">Load wanted_stage_number</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32791"></span>8017</td>
<td class="instruction">LD HL,$A13A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at current_stage_number</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32794"></span>801A</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="2">Exit if they match</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32795"></span>801B</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32796"></span>801C</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">current_stage_number = wanted_stage_number</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32797"></span>801D</td>
<td class="instruction">LD ($A220),A</td>
<td class="comment-1" rowspan="1">Set var_a220 to wanted level no.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32800"></span>8020</td>
<td class="instruction">ADD A,$B0</td>
<td class="comment-1" rowspan="2">Update the level number in "SEARCHING FOR &lt;N&gt;"</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32802"></span>8022</td>
<td class="instruction">LD ($81AE),A</td>
</tr>
<tr>
<td class="asm-label">load_stage_0</td>
<td class="address-2"><span id="32805"></span>8025</td>
<td class="instruction">CALL <a href="BDC1.html">clear_screen_set_attrs</a></td>
<td class="comment-1" rowspan="1">Call clear_screen_set_attrs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32808"></span>8028</td>
<td class="instruction">CALL <a href="88D5.html">clear_game_attrs</a></td>
<td class="comment-1" rowspan="1">Call clear_game_attrs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32811"></span>802B</td>
<td class="instruction">LD A,$F8</td>
<td class="comment-1" rowspan="1">Transition type?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32813"></span>802D</td>
<td class="instruction">CALL <a href="8DF9.html">setup_transition</a></td>
<td class="comment-1" rowspan="1">Call setup_transition</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32816"></span>8030</td>
<td class="instruction">LD B,$02</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">load_stage_1</td>
<td class="address-2"><span id="32818"></span>8032</td>
<td class="instruction">CALL <a href="8014.html#32904">sub_8088</a></td>
<td class="comment-1" rowspan="1">Call TBD subroutine</td>
</tr>
<tr>
<td class="asm-label">load_stage_2</td>
<td class="address-2"><span id="32821"></span>8035</td>
<td class="instruction">LD IX,$A19C</td>
<td class="comment-1" rowspan="1">IX = &amp;hazards[1]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32825"></span>8039</td>
<td class="instruction">LD DE,$0002</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32828"></span>803C</td>
<td class="instruction">CALL <a href="80B9.html#32960">tape_load</a></td>
<td class="comment-1" rowspan="1">Call tape_load subroutine</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32831"></span>803F</td>
<td class="instruction">JR NC,<a href="8014.html#32821">load_stage_2</a></td>
<td class="comment-1" rowspan="1">loop while failed perhaps?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32833"></span>8041</td>
<td class="instruction">LD HL,$A19C</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> = &amp;hazards[1]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32836"></span>8044</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load used flag [doesn't add up - this is a level number?]</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32837"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="E810.html">entrypt_48k</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">load_stage_3</td>
<td class="address-2"><span id="32837"></span>8045</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32838"></span>8046</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">equal to &lt;distance related&gt;?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32839"></span>8047</td>
<td class="instruction">JR NZ,<a href="8014.html#32821">load_stage_2</a></td>
<td class="comment-1" rowspan="1">jump if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32841"></span>8049</td>
<td class="instruction">ADD A,$B0</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> += (48 + 128) (make it ASCII and terminate it)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32843"></span>804B</td>
<td class="instruction">LD ($81BA),A</td>
<td class="comment-1" rowspan="1">Set x in "FOUND x"</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32846"></span>804E</td>
<td class="instruction">LD B,$03</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32848"></span>8050</td>
<td class="instruction">LD A,($8007)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> = wanted_stage_number</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32851"></span>8053</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">equal?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32852"></span>8054</td>
<td class="instruction">JR NZ,<a href="8014.html#32818">load_stage_1</a></td>
<td class="comment-1" rowspan="1">not the wanted stage</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32854"></span>8056</td>
<td class="instruction">CALL <a href="8014.html#32904">sub_8088</a></td>
<td class="comment-1" rowspan="1">Call TBD subroutine</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32857"></span>8059</td>
<td class="instruction">CALL <a href="80B9.html">tape_load_5C00</a></td>
<td class="comment-1" rowspan="1">Call tape_load_5C00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32860"></span>805C</td>
<td class="instruction">JR NC,<a href="8014.html#32805">load_stage_0</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32862"></span>
<div class="comments">
<div class="paragraph">
Success - must have loaded the correct level data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32862"></span>805E</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Set border to black</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32863"></span>805F</td>
<td class="instruction">OUT ($FE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32865"></span>8061</td>
<td class="instruction">CALL <a href="BDC1.html">clear_screen_set_attrs</a></td>
<td class="comment-1" rowspan="1">Call clear_screen_set_attrs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32868"></span>8064</td>
<td class="instruction">CALL <a href="88D5.html">clear_game_attrs</a></td>
<td class="comment-1" rowspan="1">Call clear_game_attrs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32871"></span>8067</td>
<td class="instruction">LD HL,$81BB</td>
<td class="comment-1" rowspan="1">HL -&gt; "STOP THE TAPE" message structure</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32874"></span>806A</td>
<td class="instruction">LD B,$02</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32876"></span>806C</td>
<td class="instruction">CALL <a href="8014.html#32920">sub_8098</a></td>
<td class="comment-1" rowspan="1">Call sub_8098</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32879"></span>806F</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve ?</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32880"></span>
<div class="comments">
<div class="paragraph">
Wait for a keypress - debounce.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">load_stage_4</td>
<td class="address-2"><span id="32880"></span>8070</td>
<td class="instruction">CALL <a href="A0CC.html#41174">keyscan</a></td>
<td class="comment-1" rowspan="1">Call keyscan</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32883"></span>8073</td>
<td class="instruction">AND $10</td>
<td class="comment-1" rowspan="2">Loop while key not pressed</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32885"></span>8075</td>
<td class="instruction">JR Z,<a href="8014.html#32880">load_stage_4</a></td>
</tr>
<tr>
<td class="asm-label">load_stage_5</td>
<td class="address-2"><span id="32887"></span>8077</td>
<td class="instruction">CALL <a href="A0CC.html#41174">keyscan</a></td>
<td class="comment-1" rowspan="1">Call keyscan</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32890"></span>807A</td>
<td class="instruction">AND $10</td>
<td class="comment-1" rowspan="2">Loop while key pressed</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32892"></span>807C</td>
<td class="instruction">JR NZ,<a href="8014.html#32887">load_stage_5</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32894"></span>807E</td>
<td class="instruction">LD A,$08</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32896"></span>8080</td>
<td class="instruction">CALL <a href="8DF9.html">setup_transition</a></td>
<td class="comment-1" rowspan="1">Call setup_transition</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32899"></span>8083</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore ?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32900"></span>8084</td>
<td class="instruction">LD B,$02</td>
<td class="comment-1" rowspan="1">B = 2</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32902"></span>8086</td>
<td class="instruction">JR <a href="8014.html#32920">sub_8098</a></td>
<td class="comment-1" rowspan="1">Exit via sub_8098</td>
</tr>
<tr>
<td class="asm-label">sub_8088</td>
<td class="address-2"><span id="32904"></span>8088</td>
<td class="instruction">LD HL,$818C</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "START TAPE" message structure</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32907"></span>808B</td>
<td class="instruction">LD A,($8007)</td>
<td class="comment-1" rowspan="2">A = wanted_stage_number - 1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32910"></span>808E</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32911"></span>808F</td>
<td class="instruction">JR NZ,<a href="8014.html#32917">sub_8095</a></td>
<td class="comment-1" rowspan="1">Jump if &gt; 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32913"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="E810.html">entrypt_48k</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">load_stage_6</td>
<td class="address-2"><span id="32913"></span>8091</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32914"></span>8092</td>
<td class="instruction">LD HL,$8169</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at tape_messsages</td>
</tr>
<tr>
<td class="asm-label">sub_8095</td>
<td class="address-2"><span id="32917"></span>8095</td>
<td class="instruction">CALL <a href="8014.html#32920">sub_8098</a></td>
<td class="comment-1" rowspan="1">why call adjacent instr? to exec this func twice?</td>
</tr>
<tr>
<td class="asm-label">sub_8098</td>
<td class="address-2"><span id="32920"></span>8098</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">preserve counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32921"></span>8099</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">preserve message pointer</td>
</tr>
<tr>
<td class="asm-label">sub_809A</td>
<td class="address-2"><span id="32922"></span>809A</td>
<td class="instruction">LD A,$05</td>
<td class="comment-1" rowspan="1">flags byte for print_message</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32924"></span>809C</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">why dec here?</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32925"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F220.html">page_in_stage_128k</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">sub_809D</td>
<td class="address-2"><span id="32925"></span>809D</td>
<td class="instruction">CALL <a href="8E6C.html">print_message</a></td>
<td class="comment-1" rowspan="1">Call print_message</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32928"></span>80A0</td>
<td class="instruction">DJNZ <a href="8014.html#32922">sub_809A</a></td>
<td class="comment-1" rowspan="1">printing a whole set by looping?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32930"></span>80A2</td>
<td class="instruction">CALL <a href="8D8F.html">transition</a></td>
<td class="comment-1" rowspan="1">Call transition</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32933"></span>80A5</td>
<td class="instruction">CALL <a href="BC3E.html">draw_screen</a></td>
<td class="comment-1" rowspan="1">Call draw_screen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32936"></span>80A8</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">restore message pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32937"></span>80A9</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">restore counter</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32938"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F220.html">page_in_stage_128k</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">load_stage_7</td>
<td class="address-2"><span id="32938"></span>80AA</td>
<td class="instruction">LD A,($A231)</td>
<td class="comment-1" rowspan="1">A = transition_control</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32941"></span>80AD</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">Return if zero</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32942"></span>80AE</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32943"></span>80AF</td>
<td class="instruction">LD DE,$0A00</td>
<td class="comment-1" rowspan="5">Delay loop</td>
</tr>
<tr>
<td class="asm-label">load_stage_8</td>
<td class="address-2"><span id="32946"></span>80B2</td>
<td class="instruction">DEC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32947"></span>80B3</td>
<td class="instruction">LD A,D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32948"></span>80B4</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32949"></span>80B5</td>
<td class="instruction">JR NZ,<a href="8014.html#32946">load_stage_8</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="32951"></span>80B7</td>
<td class="instruction">JR <a href="8014.html#32920">sub_8098</a></td>
<td class="comment-1" rowspan="1">Loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8008.html">8008</a>
</td>
<td class="up">Up: <a href="../maps/all.html#32788">Map</a></td>
<td class="next">
Next: <a href="80B9.html">80B9</a>
</td>
</tr>
</table>
<footer>
<div class="release">The incomplete Chase H.Q. disassembly 20231102</div>
<div class="copyright">&copy; 1988 Taito Corporation &copy; 1989 Ocean Software Ltd. (Chase H.Q.) © 2023 David Thomas (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.9.</div>
</footer>
</body>
</html>