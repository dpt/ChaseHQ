<!DOCTYPE html>
<html>
<head>
<title>Chase H.Q.: Routine at C0E1</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Chase H.Q.</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="BDFB.html">BDFB</a>
</td>
<td class="up">Up: <a href="../maps/all.html#49377">Map</a></td>
<td class="next">
Next: <a href="C15B.html">C15B</a>
</td>
</tr>
</table>
<div class="description">C0E1: Tunnel setup?</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="8401.html">main_loop</a>, <a href="852A.html">cpu_driver</a> and <a href="873C.html">escape_scene</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">tunnel_setup</td>
<td class="address-2"><span id="49377"></span>C0E1</td>
<td class="instruction">LD A,($C161)</td>
<td class="comment-1" rowspan="1">Read 'LD A,x' at $C160 (tunnel drawing code)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49380"></span>C0E4</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Set flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49381"></span>C0E5</td>
<td class="instruction">LD A,($C890)</td>
<td class="comment-1" rowspan="1">Read 'LD A,x' at $C88F (TBD)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49384"></span>C0E8</td>
<td class="instruction">JR NZ,<a href="C0E1.html#49476">tunnel_setup_1</a></td>
<td class="comment-1" rowspan="1">Jump if tunnel has appeared</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="49386"></span>
<div class="comments">
<div class="paragraph">
Tunnel hasn't appeared.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">no_tunnel</td>
<td class="address-1"><span id="49386"></span>C0EA</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Set flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49387"></span>C0EB</td>
<td class="instruction">JR NZ,<a href="C0E1.html#49408">yes_a_tunnel</a></td>
<td class="comment-1" rowspan="1">Jump if non-zero</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49389"></span>C0ED</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">tunnel_sfx = 0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49390"></span>C0EE</td>
<td class="instruction">LD ($A23B),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49393"></span>C0F1</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="2"><span class="register">HL</span> = 0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49394"></span>C0F2</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49395"></span>C0F3</td>
<td class="instruction">LD ($8F82),A</td>
<td class="comment-1" rowspan="1">$8F82 = NOP (instruction)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49398"></span>C0F6</td>
<td class="instruction">LD ($8F83),HL</td>
<td class="comment-1" rowspan="1">$8F83 &amp; $8F84 = NOP (instruction)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49401"></span>C0F9</td>
<td class="instruction">LD ($8FA7),A</td>
<td class="comment-1" rowspan="1">$8FA7 = NOP (instruction)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49404"></span>C0FC</td>
<td class="instruction">LD ($8FA8),HL</td>
<td class="comment-1" rowspan="1">$8FA8 &amp; $8FA9 = NOP (instruction)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49407"></span>C0FF</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="49408"></span>
<div class="comments">
<div class="paragraph">
Tunnel has appeared.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">yes_a_tunnel</td>
<td class="address-2"><span id="49408"></span>C100</td>
<td class="instruction">LD A,$05</td>
<td class="comment-1" rowspan="2">tunnel_sfx = 5  -- this quietens noises when in the tunnel</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49410"></span>C102</td>
<td class="instruction">LD ($A23B),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49413"></span>C105</td>
<td class="instruction">LD HL,$EAF3</td>
<td class="comment-1" rowspan="1">-- somewhere in road height data table</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49416"></span>C108</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="6"><span class="register">BC</span> = wordat(HL); <span class="register">HL</span> -= 4</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49417"></span>C109</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49418"></span>C10A</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49419"></span>C10B</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49420"></span>C10C</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49421"></span>C10D</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49422"></span>C10E</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49423"></span>C10F</td>
<td class="instruction">LD HL,$EAF1</td>
<td class="comment-1" rowspan="1">-- somewhere in road height data table</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49426"></span>C112</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-1" rowspan="6"><span class="register">DE</span> = wordat(HL); <span class="register">HL</span> -= 4</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49427"></span>C113</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49428"></span>C114</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49429"></span>C115</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49430"></span>C116</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49431"></span>C117</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label">tunnel_loop</td>
<td class="address-2"><span id="49432"></span>C118</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49433"></span>C119</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-1" rowspan="3"><span class="register">DE</span> = wordat(HL); <span class="register">HL</span>--</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49434"></span>C11A</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49435"></span>C11B</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49436"></span>C11C</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Stack <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49437"></span>C11D</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="3"><span class="register">HL</span> -= 3</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49438"></span>C11E</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49439"></span>C11F</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49440"></span>C120</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49441"></span>C121</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> -= <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49443"></span>C123</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Unstack</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49444"></span>C124</td>
<td class="instruction">JR C,<a href="C0E1.html#49465">tunnel_setup_0</a></td>
<td class="comment-1" rowspan="1">Jump if <span class="register">HL</span> &lt; <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49446"></span>C126</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49447"></span>C127</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49448"></span>C128</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="6"><span class="register">BC</span> = wordat(HL); <span class="register">HL</span> -= 4</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49449"></span>C129</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49450"></span>C12A</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49451"></span>C12B</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49452"></span>C12C</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49453"></span>C12D</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49454"></span>C12E</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49455"></span>C12F</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> -= <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49457"></span>C131</td>
<td class="instruction">JR C,<a href="C0E1.html#49465">tunnel_setup_0</a></td>
<td class="comment-1" rowspan="1">Jump if <span class="register">HL</span> &lt; BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49459"></span>C133</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49460"></span>C134</td>
<td class="instruction">LD D,B</td>
<td class="comment-1" rowspan="2"><span class="register">DE</span> = <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49461"></span>C135</td>
<td class="instruction">LD E,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49462"></span>C136</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">A--</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49463"></span>C137</td>
<td class="instruction">JR NZ,<a href="C0E1.html#49432">tunnel_loop</a></td>
<td class="comment-1" rowspan="1">Loop to tunnel_loop</td>
</tr>
<tr>
<td class="asm-label">tunnel_setup_0</td>
<td class="address-2"><span id="49465"></span>C139</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="2">A = 9 - A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49466"></span>C13A</td>
<td class="instruction">ADD A,$0A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49468"></span>C13C</td>
<td class="instruction">LD ($C15E),A</td>
<td class="comment-1" rowspan="1">Self modify 'CP x' at $C15D  [15 when tunnel is small, 6 when fills screen]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49471"></span>C13F</td>
<td class="instruction">LD A,$02</td>
<td class="comment-1" rowspan="1">A = 2</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49473"></span>C141</td>
<td class="instruction">LD ($C161),A</td>
<td class="comment-1" rowspan="1">Self modify 'LD A,x' at $C160</td>
</tr>
<tr>
<td class="asm-label">tunnel_setup_1</td>
<td class="address-2"><span id="49476"></span>C144</td>
<td class="instruction">XOR $01</td>
<td class="comment-1" rowspan="1">A = 3</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49478"></span>C146</td>
<td class="instruction">LD ($C2B9),A</td>
<td class="comment-1" rowspan="1">Self modify 'LD A,x' at $C2B8</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49481"></span>C149</td>
<td class="instruction">LD HL,$C15B</td>
<td class="comment-1" rowspan="6">Self modify $8F82 and $8FA7 to be CALL &lt;tunnel drawing code&gt;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49484"></span>C14C</td>
<td class="instruction">LD A,$CD</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49486"></span>C14E</td>
<td class="instruction">LD ($8F82),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49489"></span>C151</td>
<td class="instruction">LD ($8F83),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49492"></span>C154</td>
<td class="instruction">LD ($8FA7),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49495"></span>C157</td>
<td class="instruction">LD ($8FA8),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="49498"></span>C15A</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="BDFB.html">BDFB</a>
</td>
<td class="up">Up: <a href="../maps/all.html#49377">Map</a></td>
<td class="next">
Next: <a href="C15B.html">C15B</a>
</td>
</tr>
</table>
<footer>
<div class="release">The incomplete Chase H.Q. disassembly 20230518</div>
<div class="copyright">&copy; 1988 Taito Corporation &copy; 1989 Ocean Software Ltd. (Chase H.Q.) © 2023 David Thomas (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.9.</div>
</footer>
</body>
</html>